<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MySQL DDL 转 Sequelize 工具</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .main-content {
            padding: 40px;
        }
        
        .input-section, .output-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.4rem;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s ease;
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .controls {
            text-align: center;
            margin: 30px 0;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0 10px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .output-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1rem;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }
        
        .tab:hover {
            color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .output-area {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            min-height: 300px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .output-container {
            position: relative;
        }
        
        .example-ddl {
            background: #f0f8ff;
            border: 1px solid #b0c4de;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .feature-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .feature-list h3 {
            color: #667eea;
            margin-top: 0;
        }
        
        .feature-list ul {
            padding-left: 20px;
        }
        
        .feature-list li {
            margin: 8px 0;
            color: #555;
        }
        
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MySQL DDL 转 Sequelize</h1>
            <p>一键将 MySQL DDL 语句转换为完整的 Sequelize 模型代码</p>
        </div>
        
        <div class="main-content">
            <div class="feature-list">
                <h3>🚀 功能特性</h3>
                <ul>
                    <li>📊 自动解析 MySQL DDL 语句</li>
                    <li>🏗️ 生成 Sequelize 模型定义</li>
                    <li>🔄 生成数据库迁移文件</li>
                    <li>🌱 生成种子数据文件</li>
                    <li>🔧 支持常见数据类型映射</li>
                    <li>🔗 处理外键关系</li>
                    <li>📋 一键复制生成的代码</li>
                </ul>
            </div>
            
            <div class="input-section">
                <h2 class="section-title">📝 输入 MySQL DDL</h2>
                <div class="example-ddl">
                    <strong>示例 DDL：</strong><br>
                    CREATE TABLE users (<br>
                    &nbsp;&nbsp;id INT AUTO_INCREMENT PRIMARY KEY,<br>
                    &nbsp;&nbsp;username VARCHAR(50) NOT NULL UNIQUE,<br>
                    &nbsp;&nbsp;email VARCHAR(100) NOT NULL,<br>
                    &nbsp;&nbsp;password VARCHAR(255) NOT NULL,<br>
                    &nbsp;&nbsp;created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,<br>
                    &nbsp;&nbsp;updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP<br>
                    );
                </div>
                <textarea id="ddlInput" placeholder="在这里输入您的 MySQL DDL 语句...

-- 示例 1: 基本用户表
CREATE TABLE users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  username VARCHAR(50) NOT NULL UNIQUE,
  email VARCHAR(100) NOT NULL,
  password VARCHAR(255) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 示例 2: 带外键的文章表
CREATE TABLE posts (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL,
  title VARCHAR(200) NOT NULL,
  content TEXT,
  status ENUM('draft', 'published', 'archived') DEFAULT 'draft',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 支持的格式：
-- ✅ CREATE TABLE table_name (...)
-- ✅ CREATE TABLE IF NOT EXISTS table_name (...)
-- ✅ CREATE TABLE `table_name` (...)
-- ✅ 反引号包围的字段名
-- ✅ ENGINE=InnoDB, CHARSET=utf8mb4 等选项"></textarea>
            </div>
            
            <div class="controls">
                <button class="btn" onclick="convertDDL()">🔄 转换为 Sequelize</button>
                <button class="btn" onclick="clearAll()">🗑️ 清空</button>
            </div>
            
            <div class="output-section">
                <h2 class="section-title">📤 生成的 Sequelize 代码</h2>
                
                <div class="output-tabs">
                    <button class="tab active" onclick="showTab('models')">📄 模型文件</button>
                    <button class="tab" onclick="showTab('migration')">🔄 迁移文件</button>
                    <button class="tab" onclick="showTab('seeders')">🌱 种子文件</button>
                    <button class="tab" onclick="showTab('commands')">⚡ CLI 命令</button>
                </div>
                
                <div id="models" class="tab-content active">
                    <div class="output-container">
                        <button class="copy-btn" onclick="copyToClipboard('modelsOutput')">📋 复制</button>
                        <div id="modelsOutput" class="output-area">请先输入 DDL 并点击转换...</div>
                    </div>
                </div>
                
                <div id="migration" class="tab-content">
                    <div class="output-container">
                        <button class="copy-btn" onclick="copyToClipboard('migrationOutput')">📋 复制</button>
                        <div id="migrationOutput" class="output-area">请先输入 DDL 并点击转换...</div>
                    </div>
                </div>
                
                <div id="seeders" class="tab-content">
                    <div class="output-container">
                        <button class="copy-btn" onclick="copyToClipboard('seedersOutput')">📋 复制</button>
                        <div id="seedersOutput" class="output-area">请先输入 DDL 并点击转换...</div>
                    </div>
                </div>
                
                <div id="commands" class="tab-content">
                    <div class="output-container">
                        <button class="copy-btn" onclick="copyToClipboard('commandsOutput')">📋 复制</button>
                        <div id="commandsOutput" class="output-area">请先输入 DDL 并点击转换...</div>
                    </div>
                </div>
            </div>
            
            <div class="warning">
                <strong>⚠️ 注意：</strong>生成的代码可能需要根据您的具体需求进行调整。请检查数据类型映射、关系定义和约束条件是否符合您的预期。
            </div>
        </div>
    </div>

    <script>
        function showTab(tabName) {
            // 隐藏所有选项卡内容
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));
            
            // 移除所有选项卡的active类
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // 显示选中的选项卡内容
            document.getElementById(tabName).classList.add('active');
            
            // 添加选中选项卡的active类
            event.target.classList.add('active');
        }

        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '✅ 已复制';
                btn.style.background = '#28a745';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#667eea';
                }, 2000);
            }).catch(err => {
                console.error('复制失败:', err);
                alert('复制失败，请手动复制');
            });
        }

        function clearAll() {
            document.getElementById('ddlInput').value = '';
            document.getElementById('modelsOutput').textContent = '请先输入 DDL 并点击转换...';
            document.getElementById('migrationOutput').textContent = '请先输入 DDL 并点击转换...';
            document.getElementById('seedersOutput').textContent = '请先输入 DDL 并点击转换...';
            document.getElementById('commandsOutput').textContent = '请先输入 DDL 并点击转换...';
        }

        function convertDDL() {
            const ddlInput = document.getElementById('ddlInput').value.trim();
            
            if (!ddlInput) {
                alert('请输入 DDL 语句');
                return;
            }

            try {
                console.log('开始解析 DDL:', ddlInput);
                const tables = parseDDL(ddlInput);
                
                console.log('解析结果:', tables);
                
                if (tables.length === 0) {
                    alert('未找到有效的表定义。请检查您的 DDL 语法是否正确。\n\n确保：\n1. 包含 CREATE TABLE 语句\n2. 表名和列名正确\n3. 每个语句以分号结尾\n4. 语法符合 MySQL 标准');
                    
                    // 在控制台显示更多调试信息
                    console.log('DDL 解析失败，原始输入：', ddlInput);
                    
                    // 尝试简单的表名匹配
                    const simpleTableMatch = ddlInput.match(/CREATE\s+TABLE\s+(\w+)/gi);
                    if (simpleTableMatch) {
                        console.log('找到的表名:', simpleTableMatch);
                        alert('检测到表定义，但解析失败。请检查语法格式。\n找到的表: ' + simpleTableMatch.join(', '));
                    } else {
                        alert('未检测到 CREATE TABLE 语句。请确保输入正确的 DDL 语句。');
                    }
                    return;
                }

                const models = generateModels(tables);
                const migration = generateMigration(tables);
                const seeders = generateSeeders(tables);
                const commands = generateCommands(tables);

                document.getElementById('modelsOutput').textContent = models;
                document.getElementById('migrationOutput').textContent = migration;
                document.getElementById('seedersOutput').textContent = seeders;
                document.getElementById('commandsOutput').textContent = commands;

                console.log('转换完成，生成了', tables.length, '个表的代码');

            } catch (error) {
                alert('解析 DDL 时出错: ' + error.message + '\n\n请检查 DDL 语法是否正确，或在浏览器控制台查看详细错误信息。');
                console.error('DDL 解析错误:', error);
                console.error('错误堆栈:', error.stack);
            }
        }

        function parseDDL(ddl) {
            const tables = [];
            // 改进的正则表达式，支持更多格式
            const tableRegex = /CREATE\s+TABLE\s+(?:IF\s+NOT\s+EXISTS\s+)?`?(\w+)`?\s*\(([\s\S]*?)\)(?:\s*ENGINE\s*=\s*\w+)?(?:\s*DEFAULT\s+CHARSET\s*=\s*[\w\-]+)?(?:\s*COLLATE\s*=\s*[\w\-]+)?(?:\s*AUTO_INCREMENT\s*=\s*\d+)?(?:\s*COMMENT\s*=\s*'[^']*')?;?/gi;
            let match;

            // 清理DDL输入，移除注释
            ddl = ddl.replace(/--.*$/gm, '').replace(/\/\*[\s\S]*?\*\//g, '');

            while ((match = tableRegex.exec(ddl)) !== null) {
                const tableName = match[1];
                const columns = [];
                const foreignKeys = [];
                const indexes = [];
                
                const columnDefinitions = match[2];
                console.log(`解析表: ${tableName}`);
                console.log(`列定义: ${columnDefinitions}`);
                
                // 改进的分割逻辑，处理括号内的逗号
                const lines = splitByComma(columnDefinitions);

                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (!trimmedLine) continue;
                    
                    console.log(`处理行: ${trimmedLine}`);
                    
                    if (trimmedLine.toLowerCase().includes('foreign key')) {
                        const fkMatch = trimmedLine.match(/FOREIGN\s+KEY\s*\(`?(\w+)`?\)\s+REFERENCES\s+`?(\w+)`?\s*\(`?(\w+)`?\)(?:\s+ON\s+DELETE\s+(CASCADE|RESTRICT|SET\s+NULL|NO\s+ACTION))?(?:\s+ON\s+UPDATE\s+(CASCADE|RESTRICT|SET\s+NULL|NO\s+ACTION))?/i);
                        if (fkMatch) {
                            foreignKeys.push({
                                column: fkMatch[1],
                                references: fkMatch[2],
                                referencesColumn: fkMatch[3],
                                onDelete: fkMatch[4] || 'RESTRICT',
                                onUpdate: fkMatch[5] || 'RESTRICT'
                            });
                        }
                    } else if (trimmedLine.toLowerCase().match(/^(primary\s+key|key|index|unique\s+key|unique\s+index)/)) {
                        // 跳过索引定义
                        continue;
                    } else if (trimmedLine.toLowerCase().includes('constraint')) {
                        // 跳过约束定义
                        continue;
                    } else {
                        const column = parseColumn(trimmedLine);
                        if (column) {
                            columns.push(column);
                            console.log(`成功解析列: ${column.name}`);
                        }
                    }
                }

                if (columns.length > 0) {
                    tables.push({
                        name: tableName,
                        columns: columns,
                        foreignKeys: foreignKeys
                    });
                    console.log(`成功添加表: ${tableName}, 列数: ${columns.length}`);
                }
            }

            console.log(`总共解析到 ${tables.length} 个表`);
            return tables;
        }

        // 智能分割函数，处理括号内的逗号
        function splitByComma(str) {
            const result = [];
            let current = '';
            let parenCount = 0;
            let inQuotes = false;
            let quoteChar = '';

            for (let i = 0; i < str.length; i++) {
                const char = str[i];
                
                if (!inQuotes && (char === "'" || char === '"')) {
                    inQuotes = true;
                    quoteChar = char;
                } else if (inQuotes && char === quoteChar) {
                    inQuotes = false;
                    quoteChar = '';
                }
                
                if (!inQuotes) {
                    if (char === '(') {
                        parenCount++;
                    } else if (char === ')') {
                        parenCount--;
                    }
                }
                
                if (char === ',' && parenCount === 0 && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            if (current.trim()) {
                result.push(current.trim());
            }
            
            return result;
        }

        function parseColumn(columnDef) {
            if (!columnDef || !columnDef.trim()) return null;
            
            // 移除反引号
            columnDef = columnDef.replace(/`/g, '');
            
            const parts = columnDef.trim().split(/\s+/);
            if (parts.length < 2) return null;

            const name = parts[0];
            const dataType = parts[1];
            
            console.log(`解析列: ${name}, 类型: ${dataType}`);
            
            // 检查是否是有效的列名（排除关键字）
            const keywords = ['primary', 'key', 'foreign', 'constraint', 'index', 'unique', 'check'];
            if (keywords.some(keyword => name.toLowerCase().includes(keyword))) {
                console.log(`跳过关键字: ${name}`);
                return null;
            }
            
            const column = {
                name: name,
                type: mapDataType(dataType),
                allowNull: !columnDef.toLowerCase().includes('not null'),
                primaryKey: columnDef.toLowerCase().includes('primary key'),
                autoIncrement: columnDef.toLowerCase().includes('auto_increment'),
                unique: columnDef.toLowerCase().includes('unique') && !columnDef.toLowerCase().includes('primary key'),
                defaultValue: extractDefaultValue(columnDef)
            };

            return column;
        }

        function mapDataType(mysqlType) {
            const type = mysqlType.toLowerCase();
            
            if (type.includes('int')) {
                return 'INTEGER';
            } else if (type.includes('varchar') || type.includes('char')) {
                const match = type.match(/\((\d+)\)/);
                return match ? `STRING(${match[1]})` : 'STRING';
            } else if (type.includes('text')) {
                return 'TEXT';
            } else if (type.includes('decimal') || type.includes('numeric')) {
                const match = type.match(/\((\d+),(\d+)\)/);
                return match ? `DECIMAL(${match[1]}, ${match[2]})` : 'DECIMAL';
            } else if (type.includes('float')) {
                return 'FLOAT';
            } else if (type.includes('double')) {
                return 'DOUBLE';
            } else if (type.includes('boolean') || type.includes('bool')) {
                return 'BOOLEAN';
            } else if (type.includes('date')) {
                return 'DATE';
            } else if (type.includes('timestamp')) {
                return 'DATE';
            } else if (type.includes('datetime')) {
                return 'DATE';
            } else if (type.includes('enum')) {
                const match = type.match(/enum\s*\((.*?)\)/i);
                if (match) {
                    const values = match[1].split(',').map(v => v.trim().replace(/['"]/g, ''));
                    return `ENUM(${values.map(v => `'${v}'`).join(', ')})`;
                }
                return 'STRING';
            } else if (type.includes('json')) {
                return 'JSON';
            }
            
            return 'STRING';
        }

        function extractDefaultValue(columnDef) {
            // 匹配 DEFAULT 后面的值，考虑各种情况
            const defaultMatch = columnDef.match(/DEFAULT\s+((?:'[^']*'|"[^"]*"|\w+|\([^)]*\)|CURRENT_TIMESTAMP|NOW\(\)|NULL))/i);
            if (defaultMatch) {
                let value = defaultMatch[1].trim();
                
                if (value.toLowerCase() === 'current_timestamp' || value.toLowerCase() === 'now()') {
                    return 'DataTypes.NOW';
                } else if (value.toLowerCase() === 'null') {
                    return null;
                } else if (value.match(/^['"].*['"]$/)) {
                    return value;
                } else if (!isNaN(value) && value !== '') {
                    return value;
                } else if (value.startsWith('(') && value.endsWith(')')) {
                    return value; // 函数调用
                }
                return `'${value}'`;
            }
            return null;
        }

        function generateModels(tables) {
            let output = '';
            
            for (const table of tables) {
                const modelName = toPascalCase(table.name);
                
                output += `// models/${table.name}.js\n`;
                output += `const { DataTypes } = require('sequelize');\n`;
                output += `const sequelize = require('../config/database');\n\n`;
                
                output += `const ${modelName} = sequelize.define('${modelName}', {\n`;
                
                for (const column of table.columns) {
                    output += `  ${column.name}: {\n`;
                    output += `    type: DataTypes.${column.type},\n`;
                    
                    if (column.primaryKey) {
                        output += `    primaryKey: true,\n`;
                    }
                    
                    if (column.autoIncrement) {
                        output += `    autoIncrement: true,\n`;
                    }
                    
                    if (!column.allowNull) {
                        output += `    allowNull: false,\n`;
                    }
                    
                    if (column.unique) {
                        output += `    unique: true,\n`;
                    }
                    
                    if (column.defaultValue !== null) {
                        output += `    defaultValue: ${column.defaultValue},\n`;
                    }
                    
                    output += `  },\n`;
                }
                
                output += `}, {\n`;
                output += `  tableName: '${table.name}',\n`;
                output += `  timestamps: true,\n`;
                output += `  createdAt: 'created_at',\n`;
                output += `  updatedAt: 'updated_at'\n`;
                output += `});\n\n`;
                
                // 添加关联
                if (table.foreignKeys.length > 0) {
                    output += `// 关联定义\n`;
                    for (const fk of table.foreignKeys) {
                        const refModelName = toPascalCase(fk.references);
                        output += `${modelName}.belongsTo(${refModelName}, {\n`;
                        output += `  foreignKey: '${fk.column}',\n`;
                        output += `  onDelete: '${fk.onDelete}',\n`;
                        output += `  onUpdate: '${fk.onUpdate}'\n`;
                        output += `});\n`;
                    }
                    output += `\n`;
                }
                
                output += `module.exports = ${modelName};\n\n`;
                output += `${'='.repeat(60)}\n\n`;
            }
            
            return output;
        }

        function generateMigration(tables) {
            const timestamp = new Date().toISOString().replace(/[-:T]/g, '').substr(0, 14);
            let output = '';
            
            output += `// migrations/${timestamp}-create-tables.js\n`;
            output += `'use strict';\n\n`;
            output += `module.exports = {\n`;
            output += `  async up(queryInterface, Sequelize) {\n`;
            
            for (const table of tables) {
                output += `    await queryInterface.createTable('${table.name}', {\n`;
                
                for (const column of table.columns) {
                    output += `      ${column.name}: {\n`;
                    output += `        type: Sequelize.${column.type},\n`;
                    
                    if (column.primaryKey) {
                        output += `        primaryKey: true,\n`;
                    }
                    
                    if (column.autoIncrement) {
                        output += `        autoIncrement: true,\n`;
                    }
                    
                    if (!column.allowNull) {
                        output += `        allowNull: false,\n`;
                    }
                    
                    if (column.unique) {
                        output += `        unique: true,\n`;
                    }
                    
                    if (column.defaultValue !== null) {
                        output += `        defaultValue: ${column.defaultValue},\n`;
                    }
                    
                    output += `      },\n`;
                }
                
                // 添加时间戳字段
                output += `      created_at: {\n`;
                output += `        type: Sequelize.DATE,\n`;
                output += `        allowNull: false,\n`;
                output += `        defaultValue: Sequelize.NOW\n`;
                output += `      },\n`;
                output += `      updated_at: {\n`;
                output += `        type: Sequelize.DATE,\n`;
                output += `        allowNull: false,\n`;
                output += `        defaultValue: Sequelize.NOW\n`;
                output += `      }\n`;
                
                output += `    });\n\n`;
            }
            
            // 添加外键约束
            for (const table of tables) {
                for (const fk of table.foreignKeys) {
                    output += `    await queryInterface.addConstraint('${table.name}', {\n`;
                    output += `      fields: ['${fk.column}'],\n`;
                    output += `      type: 'foreign key',\n`;
                    output += `      name: 'fk_${table.name}_${fk.column}',\n`;
                    output += `      references: {\n`;
                    output += `        table: '${fk.references}',\n`;
                    output += `        field: '${fk.referencesColumn}'\n`;
                    output += `      },\n`;
                    output += `      onDelete: '${fk.onDelete}',\n`;
                    output += `      onUpdate: '${fk.onUpdate}'\n`;
                    output += `    });\n\n`;
                }
            }
            
            output += `  },\n\n`;
            output += `  async down(queryInterface, Sequelize) {\n`;
            
            // 删除外键约束
            for (const table of tables) {
                for (const fk of table.foreignKeys) {
                    output += `    await queryInterface.removeConstraint('${table.name}', 'fk_${table.name}_${fk.column}');\n`;
                }
            }
            
            // 删除表
            for (let i = tables.length - 1; i >= 0; i--) {
                output += `    await queryInterface.dropTable('${tables[i].name}');\n`;
            }
            
            output += `  }\n`;
            output += `};\n`;
            
            return output;
        }

        function generateSeeders(tables) {
            const timestamp = new Date().toISOString().replace(/[-:T]/g, '').substr(0, 14);
            let output = '';
            
            for (const table of tables) {
                output += `// seeders/${timestamp}-${table.name}.js\n`;
                output += `'use strict';\n\n`;
                output += `module.exports = {\n`;
                output += `  async up(queryInterface, Sequelize) {\n`;
                output += `    await queryInterface.bulkInsert('${table.name}', [\n`;
                
                // 生成示例数据
                output += `      {\n`;
                for (const column of table.columns) {
                    if (!column.autoIncrement && !column.name.includes('_at')) {
                        const sampleValue = generateSampleValue(column);
                        output += `        ${column.name}: ${sampleValue},\n`;
                    }
                }
                output += `        created_at: new Date(),\n`;
                output += `        updated_at: new Date()\n`;
                output += `      },\n`;
                
                output += `      // 添加更多示例数据...\n`;
                output += `    ], {});\n`;
                output += `  },\n\n`;
                output += `  async down(queryInterface, Sequelize) {\n`;
                output += `    await queryInterface.bulkDelete('${table.name}', null, {});\n`;
                output += `  }\n`;
                output += `};\n\n`;
                output += `${'='.repeat(60)}\n\n`;
            }
            
            return output;
        }

        function generateSampleValue(column) {
            if (column.type.includes('STRING')) {
                if (column.name.includes('email')) {
                    return "'example@email.com'";
                } else if (column.name.includes('name')) {
                    return "'示例名称'";
                } else if (column.name.includes('password')) {
                    return "'hashed_password'";
                }
                return "'示例文本'";
            } else if (column.type.includes('INTEGER')) {
                return '1';
            } else if (column.type.includes('BOOLEAN')) {
                return 'true';
            } else if (column.type.includes('DATE')) {
                return 'new Date()';
            } else if (column.type.includes('ENUM')) {
                const match = column.type.match(/ENUM\((.*?)\)/);
                if (match) {
                    const firstValue = match[1].split(',')[0].trim();
                    return firstValue;
                }
                return "'enum_value'";
            }
            return "'默认值'";
        }

        function generateCommands(tables) {
            let output = '';
            
            output += `# Sequelize CLI 命令\n\n`;
            output += `## 1. 初始化 Sequelize 项目\n`;
            output += `npx sequelize-cli init\n\n`;
            
            output += `## 2. 配置数据库连接\n`;
            output += `# 编辑 config/config.json 文件\n\n`;
            
            output += `## 3. 创建数据库\n`;
            output += `npx sequelize-cli db:create\n\n`;
            
            output += `## 4. 运行迁移\n`;
            output += `npx sequelize-cli db:migrate\n\n`;
            
            output += `## 5. 运行种子数据\n`;
            output += `npx sequelize-cli db:seed:all\n\n`;
            
            output += `## 6. 撤销迁移（如果需要）\n`;
            output += `npx sequelize-cli db:migrate:undo:all\n\n`;
            
            output += `## 7. 生成新的迁移文件（单个表）\n`;
            for (const table of tables) {
                output += `npx sequelize-cli migration:generate --name create-${table.name}\n`;
            }
            output += `\n`;
            
            output += `## 8. 生成种子文件（单个表）\n`;
            for (const table of tables) {
                output += `npx sequelize-cli seed:generate --name ${table.name}-seeder\n`;
            }
            output += `\n`;
            
            output += `## 9. 安装依赖\n`;
            output += `npm install sequelize mysql2\n`;
            output += `npm install --save-dev sequelize-cli\n\n`;
            
            output += `## 10. 环境变量示例 (.env)\n`;
            output += `DB_HOST=localhost\n`;
            output += `DB_PORT=3306\n`;
            output += `DB_NAME=your_database\n`;
            output += `DB_USERNAME=your_username\n`;
            output += `DB_PASSWORD=your_password\n\n`;
            
            output += `## 11. 数据库配置示例 (config/config.json)\n`;
            output += `{\n`;
            output += `  "development": {\n`;
            output += `    "username": "root",\n`;
            output += `    "password": "password",\n`;
            output += `    "database": "your_database",\n`;
            output += `    "host": "127.0.0.1",\n`;
            output += `    "dialect": "mysql"\n`;
            output += `  }\n`;
            output += `}\n\n`;
            
            output += `## 12. 模型使用示例\n`;
            for (const table of tables) {
                const modelName = toPascalCase(table.name);
                output += `const ${modelName} = require('./models/${table.name}');\n`;
            }
            output += `\n`;
            output += `// 创建记录\n`;
            if (tables.length > 0) {
                const firstTable = tables[0];
                const modelName = toPascalCase(firstTable.name);
                output += `const new${modelName} = await ${modelName}.create({ /* 数据 */ });\n\n`;
                
                output += `// 查询记录\n`;
                output += `const all${modelName}s = await ${modelName}.findAll();\n`;
                output += `const one${modelName} = await ${modelName}.findByPk(1);\n\n`;
                
                output += `// 更新记录\n`;
                output += `await ${modelName}.update({ /* 新数据 */ }, { where: { id: 1 } });\n\n`;
                
                output += `// 删除记录\n`;
                output += `await ${modelName}.destroy({ where: { id: 1 } });\n`;
            }
            
            return output;
        }

        function toPascalCase(str) {
            return str.replace(/_([a-z])/g, (g) => g[1].toUpperCase())
                     .replace(/^[a-z]/, (g) => g.toUpperCase());
        }
    </script>
</body>
</html>
